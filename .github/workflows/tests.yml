---
name: Cluster creation and destruction test

on:
    workflow_dispatch:
    pull_request:
        # the paths should be synced with ../labeler.yml
        paths:
        - modules/fixtures/**
        - modules/**.tf
        - .tool-versions
        - .github/workflows/tests.yml
        - .github/actions/**
        - justfile

# limit to a single execution per actor of this workflow
# concurrency:
#   group: "${{ github.workflow }}-${{ github.actor }}"
# TODO: re-enable this

env:
  AWS_PROFILE: "infex"
  AWS_REGION: "eu-west-2"
  TF_S3_BUCKET: "camunda-tf-rosa"

jobs:

  action-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get Short GitHub SHA
        id: short_git_sha
        # run: echo "short_git_sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
        # TODO: revert
        run: echo "short_git_sha=36224f3" >> "$GITHUB_OUTPUT"

      - name: Import Secrets
        id: secrets
        uses: hashicorp/vault-action@d1720f055e0635fd932a1d2a48f87a666a57906c # v3
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          exportEnv: false
          secrets: |
            secret/data/products/infrastructure-experience/ci/common AWS_ACCESS_KEY;
            secret/data/products/infrastructure-experience/ci/common AWS_SECRET_KEY;
            secret/data/products/infrastructure-experience/ci/common RH_OPENSHIFT_TOKEN;
            secret/data/products/infrastructure-experience/ci/common CI_OPENSHIFT_MAIN_PASSWORD;

      # Official action does not support profiles
      - name: Add profile credentials to ~/.aws/credentials
        run: |
          aws configure set aws_access_key_id ${{ steps.secrets.outputs.AWS_ACCESS_KEY }} --profile ${{ env.AWS_PROFILE }}
          aws configure set aws_secret_access_key ${{ steps.secrets.outputs.AWS_SECRET_KEY }} --profile ${{ env.AWS_PROFILE }}
          aws configure set region ${{ env.AWS_REGION }} --profile ${{ env.AWS_PROFILE }}

      - name: Create Cluster
        timeout-minutes: 125
        uses: ./.github/actions/rosa-create-cluster
        with:
          rh-token: ${{ steps.secrets.outputs.RH_OPENSHIFT_TOKEN }}
          cluster-name: "tf-rosa-${{ steps.short_git_sha.outputs.short_git_sha }}"
          admin-password: "${{ steps.secrets.outputs.CI_OPENSHIFT_MAIN_PASSWORD }}"
          aws-region: ${{ env.AWS_REGION }}
          namespace:  "myns"
          s3-backend-bucket: ${{ env.TF_S3_BUCKET }}

      - name: Delete Cluster
        timeout-minutes: 125
        if: always()
        uses: ./.github/actions/rosa-delete-cluster
        with:
          rh-token: ${{ steps.secrets.outputs.RH_OPENSHIFT_TOKEN }}
          cluster-name: "tf-rosa-${{ steps.short_git_sha.outputs.short_git_sha }}"
          aws-region: ${{ env.AWS_REGION }}
          s3-backend-bucket: ${{ env.TF_S3_BUCKET }}
